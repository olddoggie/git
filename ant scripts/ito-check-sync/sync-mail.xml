<?xml version="1.0" encoding="UTF-8"?>
<!--
	This is a Ant build file for sending mail about sync log on 7:00 AM every morning.
	
	@author Jack.Wang
	@version 1.0 Create
	@version 1.1 enhance with Cron	

-->

<!-- Define the project name and default target -->
<project name="sync-mail" default="mail" basedir="../">

<!-- Important: Define the file/dir location -->
	<property name="sync.dir" value="D:\sync"/>
	<property name="log.dir" value="${sync.dir}/sync logs"/>
	<property name="sync.script.dir" value="${log.dir}/script"/>	
	<property name="cygwin.home" value="D:\cygwin\home\jack.wang"/>

<!-- Changable: Define the mail information -->
	<property name="from" value="jack.wang@bleum.com"/>
	<property name="to" value="jack.wang@bleum.com"/>
<!--<property name="cc" value="edison.ma@bleum.com"/> -->
	
<!-- Fetch the current time -->	
	<tstamp>
		<format property="log.day" pattern="MM/dd/yyyy" />
		<format property="log.day1" pattern="MM-dd-yyyy" />
		<format property="log.week" pattern="EE"/>
	</tstamp>

	<property name="log.date" value="${log.day} 00:01 AM" />
	<property name="log.name" value="sync-ito-${log.day1} ${log.week}.txt" />

<!-- Locate the latest back up file of which the size should be more than 40 GB -->
	<path id="log.file">
		<fileset dir="${cygwin.home}">
			<include name="itosync-daily-check-log.txt"/>
		<and>
			<date datetime="${log.date}" when="after"/>
		</and>
		</fileset>
	</path>
	
<!-- Delete old files before one months -->	
	<target name="delete">
	    <exec executable="C:\WINDOWS\system32\cmd" dir="${sync.script.dir}" spawn="true">
            <arg value="/c" />
            <arg value="delete_old_log.bat" />
        </exec>
		<sleep seconds="5"/>
	</target>

<!-- Check whether log updated, if exists, set ${log.exist} to true -->
	<target name="check" >
		<condition property="log.exist">
			<available file="itosync-daily-check-log.txt">
				<filepath refid="log.file"/>
			</available>
		</condition>
	</target>

<!-- log exists then copy and set mail content -->	
	<target name="copy-if-success" depends="check" if="log.exist">
		<copy toDir="${log.dir}" overwrite="true" failonerror="false">
		<fileset dir="${cygwin.home}">
			<include name="itosync-daily-check-log.txt"/>			
		<and>
			<date datetime="${log.date}" when="after"/>
		</and>
		</fileset>
		<mapper type="glob" from="itosync-daily-check-log.txt" to="${log.name}"/>
		</copy>		
		<property name="mail.subject" value="ito CVS Daily SYNC Notifier [@ito-as1.1fb.net] -- Succeed"/>	
		<property name="mail.content" value="${log.dir}/${log.name}"/>
	</target>
	
<!-- log NOT exists sert mail content -->
	<target name="report-if-fail" depends="check" unless="file.exist">
		<property name="mail.subject" value="ito CVS Daily SYNC Notifier [@ito-as1.1fb.net] -- Fail"/>	
		<property name="mail.content" value="${sync.script.dir}/fail-mail.txt"/>
	</target>

<!-- After check send out the notification mail periodly -->	
 	<target name="mail" depends="delete,copy-if-success, report-if-fail">		
	    <exec executable="wscript" dir="${sync.script.dir}" spawn="true">
            <arg value="sync-mail.vbs" />
            <arg value="${to}" />
        <!--<arg value="${cc}" /> -->
            <arg value="${mail.subject}" />
            <arg value="${mail.content}" />
            <arg value="${log.exist}" />
        </exec>
	</target>
	
<!-- Crontab.exe does not support ant calling cmd/wscript/bash in process , use scp in crontab -e directly and skip to pre-cron task-->	
 	<target name="scp" depends="copy-if-success, report-if-fail">
		<scp file="${cygwin.home}/cron.log" todir="jack@205.185.126.116:/home/jack/back-up/ito-sync-cron.log" keyfile="${cygwin.home}/.ssh/id_rsa" trust="true"/>
		<scp file="${log.dir}/${log.name}" todir="jack@205.185.126.116:/home/jack/back-up/ito-sync-detail.log" keyfile="${cygwin.home}/.ssh/id_rsa" trust="true"/>
	</target>
	<!--
	<target name="scp">
		<sshexec host="205.185.126.116" username="jack" password="" trust="true" command="scp..."/>
	</target>
	 -->

<!-- Make sure the file uploaded to remote is up-to-date every day, similar with copy-if-success -->	
 	<target name="initial-cron">
		<delete dir="${cygwin.home}/Temp" quiet="true" />
	</target>
	<target name="copy-cron" depends="check" if="log.exist">
		<copy toDir="${cygwin.home}/Temp" overwrite="true" failonerror="false">
			<fileset dir="${cygwin.home}">
				<include name="itosync-daily-check-log.txt"/>			
			<and>
				<date datetime="${log.date}" when="after"/>
			</and>
			</fileset>
			<mapper type="glob" from="itosync-daily-check-log.txt" to="ito-sync-detail.txt"/>
		</copy>
		<copy toDir="${log.dir}" overwrite="true" failonerror="false">
			<fileset dir="${cygwin.home}/Temp" includes="ito-sync-detail.txt"/>
			<mapper type="glob" from="*.txt" to="${log.name}"/>
		</copy>
	</target>
 	<target name="pre-cron" depends="initial-cron,copy-cron" />
</project>