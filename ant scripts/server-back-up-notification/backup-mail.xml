<?xml version="1.0" encoding="UTF-8"?>
<!--
	This is a Ant build file for sending mail aboutcvs cvs back-up status.
	
	@author Jack.Wang
	@version 1.0 Create
	@version 1.1 Add delete target to save the Disk Space which maybe caused back up failure in Windows 2003 SP2
	
	$Revision: 1.5 $
-->

<!-- 
	CVS back up: 
	@local  every day on 3 A.M. 
			back up log will be generated on 7 A.M.
			weekly checked by us(Jack,Edison,Sunny).
			notification mail will be sent every Saturday 9:00 A.M.
			
	@tape  weekly on Friday 6:30 P.M. in the charge of SSG.
-->

<!-- Define the project name and default target -->
<project name="backup-mail" default="mail" basedir="../">

<!-- Important: Define the CSV repository back up location -->
	<property name="repo.dir" value="D:\CVS"/>
	<property name="task.file" value="D:\NTBakcup Task\IFB weekly.bks"/>
	<property name="script.dir" value="G:\backupconfig"/>	

<!-- Changable: Define the mail information -->
	<property name="from" value="jack.wang@bleum.com"/>
	<property name="to" value="jack.wang@bleum.com,edison.ma@bleum.com,sunny.hu@bleum.com"/>
	<property name="cc" value="bryan.wang@bleum.com,maggie.zhou@bleum.com,dean.long@bleum.com,benny.liu@bleum.com"/>
	<property name="mail.server" value="192.168.0.232" />	
	<property name="user" value="jack.wang"/>
	<property name="password" value="jkjk,33333"/>	
	
<!-- Define the properties for the script -->	
	<property name="log.dir" value="backuplog"/>
	<property name="back.dir" value="cvsbackup"/>

	<tstamp>
		<format property="log.day" pattern="MM/dd/yyyy" />
		<format property="log.day1" pattern="MM-dd-yyyy" />
		<format property="log.week" pattern="EE"/>
	</tstamp>
	
	<property name="log.date" value="${log.day} 00:01 AM" />
	<property name="back.name" value="1FBcvsbackup-${log.day1} ${log.week}.bkf" />

<!-- Locate the latest back up file of which the size should be more than 40 GB -->
	<path id="back.file">	    
		<fileset dir="${back.dir}">
			<include name="**/*.bkf"/>
		<and>
			<date datetime="${log.date}" when="after"/>
			<size value="40" units="G" when="more"/>
		</and>
		</fileset>		
	</path>
	
<!-- Delete old back up *.bkf files by only keeping the latest week's files in order to save space (daily job every 2 A.M.) -->	
	<target name="delete">
	    <exec executable="cmd" dir="${script.dir}" spawn="true">
            <arg value="/c" />
            <arg value="delete_old_backup.bat" />
        </exec>
		<sleep seconds="5"/>
	</target>

<!-- Check whether the correct back up file exists, if exists, set ${file.exist} to true -->	
	<target name="check" depends="delete">	
		<condition property="file.exist">
			<available file="${back.name}">
				<filepath refid="back.file"/>
			</available>
		</condition>
	</target>

<!-- Back up file exists mail content -->	
	<target name="backup-success-content" depends="check" if="file.exist">
		<property name="mail.subject" value="CVS Back-Up Result Notifier [@192.168.2.200] -- Succeed"/>	
		<property name="mail.content" value="${script.dir}/success-mail.txt"/>
	</target>
	
<!-- Back up file NOT exists mail content -->
	<target name="backup-fail-content" depends="check" unless="file.exist">
		<property name="mail.subject" value="CVS Back-Up Result Notifier [@192.168.2.200] -- Fail"/>	
		<property name="mail.content" value="${script.dir}/fail-mail.txt"/>
	</target>	

<!-- After check send out the notification mail periodly -->	
	<target name="mail" depends="backup-success-content, backup-fail-content">		
		<mail from="${from}" messagefile="${mail.content}" tolist="${to}" cclist="${cc}" subject="${mail.subject}" mailhost="${mail.server}" user="${user}" password="${password}">
			<attachments>
				<fileset dir="${log.dir}">
					<include name="**/*.log"/>
					<date datetime="${log.date}" when="after"/>
				</fileset>
			</attachments>
		</mail>
	</target>
	
</project>