<?xml version="1.0" encoding="UTF-8"?>
<!--
	This is a Ant build file for sending mail aboutcvs cvs back-up status.
	
	@author Jack.Wang
	@version 1.0 Create

-->

<!-- 
	SVN back up: 
	@local  dump incrementally every day on 4 A.M. 
			back up log will be generated at the same time.
			weekly checked by Jack and project team.
			notification mail will be sent every Saturday 12:00 A.M.
			
	@2CVS 	daily checked in to cvs repo by jenkins user on 2:00 A.M.
-->

<!-- Define the project name and default target -->
<project name="backup-mail" default="mail">

<!-- Important: Define the CSV repository back up location -->
	<property name="script.dir" value="/home/svn/bin/ant-scirpt"/>

<!-- Changable: Define the mail information -->
	<property name="from" value="-"/>
	<property name="to" value="-"/>
	<property name="cc" value="-"/>
	<property name="mail.server" value="192.168.0.232" />	
	<property name="user" value="-"/>
	<property name="password" value="-"/>	

<!-- Define the properties for the script -->	
	<property name="back.dir" value="/home/svn/back-up/svn2dump"/>
	<property name="log.name" value="svnback.log"/>

	<tstamp>
		<format property="log.day" pattern="MM/dd/yyyy" />
	</tstamp>

	<property name="log.date" value="${log.day} 00:01 AM" />

<!-- Locate the latest back up file of which the size should be more than 40 GB -->
	<path id="back.file">	    
		<fileset dir="${back.dir}">
			<include name="*.dump"/>
			<include name="${log.name}"/>			
		<and>
			<date datetime="${log.date}" when="after"/>
		</and>
		</fileset>		
	</path>

<!-- Check whether the correct back up file exists, if exists, set ${file.exist} to true -->	
	<target name="check">	
		<condition property="file.exist">
		<and>
			<available file="${log.name}">
				<filepath refid="back.file"/>
			</available>
		</and>	
		</condition>
	</target>

<!-- Back up file exists mail content -->	
	<target name="backup-success-content" depends="check" if="file.exist">
		<property name="mail.subject" value="SVN Back-Up Result Notifier [@192.168.2.100] -- Succeed"/>	
		<property name="mail.content" value="${script.dir}/success-mail.txt"/>
	</target>

<!-- Back up file NOT exists mail content -->
	<target name="backup-fail-content" depends="check" unless="file.exist">
		<property name="mail.subject" value="CVS Back-Up Result Notifier [@192.168.2.100] -- Fail"/>	
		<property name="mail.content" value="${script.dir}/fail-mail.txt"/>
	</target>	

<!-- After check send out the notification mail periodly -->	
	<target name="mail" depends="backup-success-content, backup-fail-content">		
		<mail from="${from}" messagefile="${mail.content}" tolist="${to}" cclist="${cc}" subject="${mail.subject}" mailhost="${mail.server}" user="${user}" password="${password}">
			<attachments>
				<fileset dir="${back.dir}">
					<include name="${log.name}"/>
					<date datetime="${log.date}" when="after"/>
				</fileset>
			</attachments>
		</mail>
	</target>
</project>